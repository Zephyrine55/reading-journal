<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --bg: #FBF8F4;
    --bg-warm: #F5F0E8;
    --text-primary: #2C2416;
    --text-secondary: #7A6F60;
    --text-light: #A89E8E;
    --accent-warm: #D4956A;
    --accent-deep: #B8734A;
    --accent-soft: #E8C9A0;
    --card-bg: #FFFFFF;
    --card-shadow: 0 2px 20px rgba(44, 36, 22, 0.06);
    --card-shadow-hover: 0 4px 30px rgba(44, 36, 22, 0.10);
    --border: #E8E2D8;
    --radius: 16px;
    --radius-sm: 10px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans SC', sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
      radial-gradient(ellipse at 20% 0%, rgba(212, 149, 106, 0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(123, 164, 184, 0.06) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .app-container {
    position: relative;
    z-index: 1;
    max-width: 480px;
    margin: 0 auto;
    padding: 20px 16px 40px;
    min-height: 100vh;
  }

  /* ===== HEADER ===== */
  .header {
    text-align: center;
    padding: 24px 0 20px;
    opacity: 0;
    animation: fadeUp 0.6s ease forwards;
  }
  .header-icon {
    font-size: 28px;
    margin-bottom: 8px;
    display: inline-block;
    animation: float 3s ease-in-out infinite;
  }
  .header h1 {
    font-family: 'Noto Serif SC', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    letter-spacing: 2px;
    margin-bottom: 4px;
  }
  .header p {
    font-size: 13px;
    color: var(--text-light);
    font-weight: 300;
  }

  .screen { display: none; }
  .screen.active { display: block; }

  /* ===== CARDS & INPUTS ===== */
  .book-info-card, .emotion-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 28px 24px;
    box-shadow: var(--card-shadow);
    margin-bottom: 16px;
    opacity: 0;
  }
  .book-info-card { animation: fadeUp 0.6s ease 0.15s forwards; }
  .emotion-section { animation: fadeUp 0.6s ease 0.25s forwards; padding: 24px; }

  .input-group { margin-bottom: 20px; }
  .input-group:last-child { margin-bottom: 0; }
  .input-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 8px;
    letter-spacing: 0.5px;
  }
  .text-input {
    width: 100%;
    padding: 12px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--text-primary);
    background: var(--bg);
    transition: var(--transition);
    outline: none;
  }
  .text-input:focus {
    border-color: var(--accent-warm);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(212, 149, 106, 0.12);
  }
  .text-input::placeholder { color: var(--text-light); font-weight: 300; }

  /* ===== EMOTION GRID ===== */
  .emotion-title {
    font-family: 'Noto Serif SC', serif;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .emotion-subtitle {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 18px;
  }
  .emotion-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .emotion-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 16px 8px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--bg);
    cursor: pointer;
    transition: var(--transition);
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .emotion-btn:active { transform: scale(0.96); }
  .emotion-btn .emoji { font-size: 26px; margin-bottom: 6px; transition: transform 0.3s ease; }
  .emotion-btn .label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .emotion-btn.selected {
    border-color: var(--accent-warm);
    background: rgba(212, 149, 106, 0.08);
    box-shadow: 0 0 0 3px rgba(212, 149, 106, 0.10);
  }
  .emotion-btn.selected .emoji { transform: scale(1.15); }
  .emotion-btn.selected .label { color: var(--accent-deep); font-weight: 600; }
  .multi-hint {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    margin-top: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .multi-hint.visible { opacity: 1; }

  /* ===== BUTTONS ===== */
  .btn-primary {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-weight: 600;
    font-family: 'Noto Sans SC', sans-serif;
    color: #fff;
    background: linear-gradient(135deg, var(--accent-warm), var(--accent-deep));
    cursor: pointer;
    transition: var(--transition);
    opacity: 0;
    animation: fadeUp 0.6s ease 0.35s forwards;
    letter-spacing: 1px;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-primary:disabled { opacity: 0.4 !important; cursor: not-allowed; }
  .btn-primary:not(:disabled):active {
    transform: scale(0.98);
    box-shadow: 0 2px 12px rgba(184, 115, 74, 0.3);
  }

  .btn-secondary {
    flex: 1;
    padding: 12px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--text-secondary);
    background: var(--bg);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-secondary:active { background: var(--border); }

  .btn-next {
    flex: 2;
    padding: 12px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: 'Noto Sans SC', sans-serif;
    color: #fff;
    background: linear-gradient(135deg, var(--accent-warm), var(--accent-deep));
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-next:active { transform: scale(0.98); }

  .btn-export {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: 'Noto Sans SC', sans-serif;
    color: #fff;
    background: linear-gradient(135deg, var(--accent-warm), var(--accent-deep));
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-export:active { transform: scale(0.98); }

  .btn-export-outline {
    flex: 1;
    padding: 14px;
    border: 1.5px solid var(--accent-soft);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--accent-deep);
    background: transparent;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-export-outline:active { background: rgba(212,149,106,0.06); }

  /* ===== QUESTION FLOW ===== */
  .question-flow { padding-top: 8px; }
  .question-progress {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    opacity: 0;
    animation: fadeUp 0.4s ease forwards;
  }
  .progress-dots { display: flex; gap: 6px; }
  .progress-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
    transition: var(--transition);
  }
  .progress-dot.done { background: var(--accent-warm); }
  .progress-dot.current { background: var(--accent-deep); width: 20px; border-radius: 4px; }
  .progress-text { font-size: 12px; color: var(--text-light); }

  .question-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 28px 24px;
    box-shadow: var(--card-shadow);
    margin-bottom: 16px;
    opacity: 0;
    animation: fadeUp 0.5s ease forwards;
  }
  .question-emoji { font-size: 32px; margin-bottom: 14px; display: inline-block; }
  .question-text {
    font-family: 'Noto Serif SC', serif;
    font-size: 17px;
    font-weight: 600;
    line-height: 1.7;
    color: var(--text-primary);
    margin-bottom: 18px;
  }
  .question-hint {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 14px;
    font-weight: 300;
    line-height: 1.6;
  }
  .answer-textarea {
    width: 100%;
    min-height: 120px;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--text-primary);
    background: var(--bg);
    transition: var(--transition);
    outline: none;
    resize: vertical;
    line-height: 1.7;
  }
  .answer-textarea:focus {
    border-color: var(--accent-warm);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(212, 149, 106, 0.12);
  }
  .answer-textarea::placeholder { color: var(--text-light); font-weight: 300; }
  .question-actions { display: flex; gap: 10px; margin-top: 16px; }

  .expand-section {
    text-align: center;
    margin: 8px 0 16px;
    opacity: 0;
    animation: fadeUp 0.5s ease 0.2s forwards;
  }
  .expand-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 20px;
    border: 1.5px dashed var(--accent-soft);
    border-radius: 24px;
    background: transparent;
    font-size: 13px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--accent-deep);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    -webkit-tap-highlight-color: transparent;
  }
  .expand-btn:active { transform: scale(0.96); }

  /* ===== COMPLETE SCREEN ===== */
  .complete-screen { text-align: center; padding-top: 60px; }
  .complete-icon {
    font-size: 56px;
    margin-bottom: 20px;
    display: inline-block;
    opacity: 0;
    animation: popIn 0.6s ease forwards;
  }
  .complete-title {
    font-family: 'Noto Serif SC', serif;
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 10px;
    opacity: 0;
    animation: fadeUp 0.5s ease 0.2s forwards;
  }
  .complete-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 36px;
    line-height: 1.7;
    opacity: 0;
    animation: fadeUp 0.5s ease 0.3s forwards;
  }

  .summary-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--card-shadow);
    text-align: left;
    margin-bottom: 20px;
    opacity: 0;
    animation: fadeUp 0.5s ease 0.4s forwards;
  }
  .summary-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }
  .summary-book-title { font-family: 'Noto Serif SC', serif; font-size: 16px; font-weight: 600; }
  .summary-meta { font-size: 12px; color: var(--text-light); }
  .summary-emotion-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
  .summary-emotion-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 12px;
    background: rgba(212, 149, 106, 0.1);
    color: var(--accent-deep);
    font-weight: 500;
  }
  .summary-qa { margin-bottom: 14px; }
  .summary-qa:last-child { margin-bottom: 0; }
  .summary-q { font-size: 12px; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
  .summary-a { font-size: 14px; color: var(--text-primary); line-height: 1.7; }

  .complete-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
    opacity: 0;
    animation: fadeUp 0.5s ease 0.45s forwards;
  }
  .btn-restart {
    width: 100%;
    padding: 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--text-secondary);
    background: var(--card-bg);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    opacity: 0;
    animation: fadeUp 0.5s ease 0.5s forwards;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-restart:active { background: var(--bg-warm); }

  /* ===== HISTORY ===== */
  .history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    opacity: 0;
    animation: fadeUp 0.4s ease forwards;
  }
  .history-header h2 { font-family: 'Noto Serif SC', serif; font-size: 18px; font-weight: 700; }
  .history-back {
    padding: 8px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-bg);
    font-size: 13px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition);
    -webkit-tap-highlight-color: transparent;
  }
  .history-back:active { background: var(--bg-warm); }

  .history-stats {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    opacity: 0;
    animation: fadeUp 0.4s ease 0.1s forwards;
  }
  .stat-card {
    flex: 1;
    background: var(--card-bg);
    border-radius: var(--radius-sm);
    padding: 14px;
    text-align: center;
    box-shadow: var(--card-shadow);
  }
  .stat-number { font-family: 'Noto Serif SC', serif; font-size: 22px; font-weight: 700; color: var(--accent-deep); }
  .stat-label { font-size: 11px; color: var(--text-light); margin-top: 2px; }

  .history-list { display: flex; flex-direction: column; gap: 12px; }
  .history-entry {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 18px 20px;
    box-shadow: var(--card-shadow);
    cursor: pointer;
    transition: var(--transition);
    opacity: 0;
    animation: fadeUp 0.4s ease forwards;
    -webkit-tap-highlight-color: transparent;
  }
  .history-entry:active { box-shadow: var(--card-shadow-hover); transform: translateY(-1px); }
  .history-entry-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .history-entry-title { font-family: 'Noto Serif SC', serif; font-size: 15px; font-weight: 600; }
  .history-entry-date { font-size: 11px; color: var(--text-light); white-space: nowrap; margin-left: 8px; }
  .history-entry-emotions { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; }
  .history-entry-emotion { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: rgba(212, 149, 106, 0.08); color: var(--accent-deep); }
  .history-entry-preview {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .history-empty { text-align: center; padding: 60px 20px; color: var(--text-light); font-size: 14px; line-height: 1.8; }
  .history-empty-icon { font-size: 40px; margin-bottom: 12px; }
  .history-export-all { margin-top: 20px; opacity: 0; animation: fadeUp 0.4s ease 0.2s forwards; }

  .detail-back {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 0;
    border: none;
    background: none;
    font-size: 13px;
    font-family: 'Noto Sans SC', sans-serif;
    color: var(--accent-deep);
    cursor: pointer;
    margin-bottom: 12px;
    -webkit-tap-highlight-color: transparent;
  }
  .detail-delete {
    padding: 10px 20px;
    border: 1.5px solid #E8D2D2;
    border-radius: var(--radius-sm);
    background: transparent;
    font-size: 13px;
    font-family: 'Noto Sans SC', sans-serif;
    color: #C27070;
    cursor: pointer;
    transition: var(--transition);
    -webkit-tap-highlight-color: transparent;
  }
  .detail-delete:active { background: #FDF5F5; }

  /* Floating history button */
  .nav-history {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--card-bg);
    border: 1.5px solid var(--border);
    box-shadow: 0 4px 16px rgba(44, 36, 22, 0.10);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: var(--transition);
    -webkit-tap-highlight-color: transparent;
    font-size: 20px;
  }
  .nav-history:active { transform: scale(0.92); }
  .nav-history .badge {
    position: absolute;
    top: -2px;
    right: -2px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent-warm);
    color: #fff;
    font-size: 10px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    padding: 10px 20px;
    background: var(--text-primary);
    color: #fff;
    border-radius: 20px;
    font-size: 13px;
    font-family: 'Noto Sans SC', sans-serif;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 100;
    pointer-events: none;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* ===== IMAGE EXPORT CARD (offscreen render) ===== */
  .export-card-container {
    position: fixed;
    left: -9999px;
    top: 0;
    z-index: -1;
  }

  .export-card {
    width: 420px;
    background: linear-gradient(170deg, #FBF8F4 0%, #F5F0E8 40%, #EDE4D6 100%);
    padding: 40px 32px 36px;
    font-family: 'Noto Sans SC', sans-serif;
    color: #2C2416;
  }

  .ec-header {
    text-align: center;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid #E8E2D8;
  }
  .ec-logo { font-size: 20px; margin-bottom: 6px; }
  .ec-app-name {
    font-family: 'Noto Serif SC', serif;
    font-size: 14px;
    font-weight: 600;
    color: #7A6F60;
    letter-spacing: 2px;
  }

  .ec-book-title {
    font-family: 'Noto Serif SC', serif;
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 8px;
  }
  .ec-meta {
    text-align: center;
    font-size: 12px;
    color: #A89E8E;
    margin-bottom: 16px;
  }
  .ec-emotions {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px;
  }
  .ec-emotion-tag {
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    background: rgba(212, 149, 106, 0.12);
    color: #B8734A;
    font-weight: 500;
  }

  .ec-divider {
    width: 40px;
    height: 2px;
    background: #E8C9A0;
    margin: 0 auto 24px;
    border-radius: 1px;
  }

  .ec-qa { margin-bottom: 20px; }
  .ec-qa:last-child { margin-bottom: 0; }
  .ec-question {
    font-size: 12px;
    color: #A89E8E;
    font-weight: 500;
    margin-bottom: 6px;
    line-height: 1.5;
  }
  .ec-answer {
    font-size: 14px;
    color: #2C2416;
    line-height: 1.8;
  }

  .ec-footer {
    margin-top: 28px;
    padding-top: 16px;
    border-top: 1px solid #E8E2D8;
    text-align: center;
    font-size: 11px;
    color: #C4B9A8;
    letter-spacing: 1px;
  }

  /* Image preview modal */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 200;
    justify-content: center;
    align-items: center;
    padding: 24px;
  }
  .modal-overlay.show { display: flex; }
  .modal-content {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    max-width: 440px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    text-align: center;
    animation: popIn 0.3s ease;
  }
  .modal-content img {
    width: 100%;
    border-radius: var(--radius-sm);
    margin-bottom: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  .modal-hint {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 14px;
    line-height: 1.6;
  }
  .modal-actions { display: flex; gap: 10px; }
  .modal-actions button { flex: 1; }

  /* ===== ANIMATIONS ===== */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes popIn {
    0% { opacity: 0; transform: scale(0.5); }
    70% { transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }
  .fade-enter { animation: fadeUp 0.4s ease forwards; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .date-display {
    text-align: center;
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 4px;
    opacity: 0;
    animation: fadeUp 0.6s ease 0.05s forwards;
  }

  /* Loading spinner for export */
  .btn-loading {
    pointer-events: none;
    opacity: 0.7 !important;
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <div class="header-icon">ğŸ“–</div>
    <h1>è¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹</h1>
    <p>è®°å½•ä½ æ­¤åˆ»çš„é˜…è¯»æ„Ÿå—</p>
  </div>
  <div class="date-display" id="dateDisplay"></div>

  <!-- SCREEN 1: Book Info + Emotion -->
  <div class="screen active" id="screen1">
    <div class="book-info-card">
      <div class="input-group">
        <label class="input-label">ğŸ“š ä¹¦å</label>
        <input class="text-input" type="text" id="bookTitle" placeholder="ä½ åœ¨è¯»ä»€ä¹ˆï¼Ÿ">
      </div>
      <div class="input-group">
        <label class="input-label">ğŸ“„ ä»Šå¤©çœ‹åˆ°å“ªäº†ï¼Ÿ</label>
        <input class="text-input" type="text" id="readingProgress" placeholder="æ¯”å¦‚ï¼šç¬¬3-6ç«  / å‰50é¡µ / çœ‹äº†1/5">
      </div>
      <div class="input-group">
        <label class="input-label">â±ï¸ å¤§æ¦‚çœ‹äº†å¤šä¹…ï¼Ÿ</label>
        <input class="text-input" type="text" id="readingTime" placeholder="æ¯”å¦‚ï¼š30åˆ†é’Ÿ / 1å°æ—¶">
      </div>
    </div>
    <div class="emotion-section">
      <div class="emotion-title">æ­¤åˆ»çš„æ„Ÿå—æ˜¯ï¼Ÿ</div>
      <div class="emotion-subtitle">å¯ä»¥é€‰æ‹© 1-2 ä¸ªæœ€è´´è¿‘çš„æ„Ÿå—</div>
      <div class="emotion-grid" id="emotionGrid">
        <button class="emotion-btn" data-emotion="moved" onclick="toggleEmotion(this)">
          <span class="emoji">ğŸ’•</span><span class="label">æ„ŸåŠ¨/å…±é¸£</span>
        </button>
        <button class="emotion-btn" data-emotion="inspired" onclick="toggleEmotion(this)">
          <span class="emoji">ğŸ’¡</span><span class="label">å¯å‘/é¡¿æ‚Ÿ</span>
        </button>
        <button class="emotion-btn" data-emotion="healed" onclick="toggleEmotion(this)">
          <span class="emoji">ğŸŒ¿</span><span class="label">æ²»æ„ˆ/å¹³é™</span>
        </button>
        <button class="emotion-btn" data-emotion="heavy" onclick="toggleEmotion(this)">
          <span class="emoji">ğŸŒŠ</span><span class="label">æ²‰é‡/å‹æŠ‘</span>
        </button>
        <button class="emotion-btn" data-emotion="curious" onclick="toggleEmotion(this)">
          <span class="emoji">ğŸ”</span><span class="label">å¥½å¥‡/æƒ³æ¢ç´¢</span>
        </button>
        <button class="emotion-btn" data-emotion="confused" onclick="toggleEmotion(this)">
          <span class="emoji">ğŸŒ€</span><span class="label">å›°æƒ‘/å¤æ‚</span>
        </button>
      </div>
      <div class="multi-hint" id="multiHint">å·²é€‰ <span id="selectedCount">0</span> ä¸ªï¼Œæœ€å¤šé€‰ 2 ä¸ª</div>
    </div>
    <button class="btn-primary" id="startBtn" disabled onclick="goToQuestions()">å¼€å§‹è®°å½•æ„Ÿå— âœï¸</button>
  </div>

  <!-- SCREEN 2: Questions -->
  <div class="screen" id="screen2">
    <div class="question-flow" id="questionFlow"></div>
  </div>

  <!-- SCREEN 3: Complete -->
  <div class="screen" id="screen3">
    <div class="complete-screen">
      <div class="complete-icon">ğŸ‰</div>
      <div class="complete-title">ä»Šå¤©çš„é˜…è¯»æ„Ÿå—ï¼Œå·²æ”¶è—</div>
      <div class="complete-subtitle">æ¯ä¸€æ¬¡è®°å½•éƒ½æ˜¯å’Œä¹¦çš„ä¸€æ¬¡å¯¹è¯<br>ä¸‹æ¬¡çœ‹å®Œå‡ ç« å†æ¥å†™ä¸€ç‚¹å§</div>
      <div class="summary-card" id="summaryCard"></div>
      <div class="complete-actions">
        <button class="btn-export" id="btnExportImg" onclick="exportCurrentAsImage()">ä¿å­˜ä¸ºå›¾ç‰‡ ğŸ–¼ï¸</button>
        <button class="btn-export-outline" onclick="exportCurrentAsMd()">å¯¼å‡ºæ–‡å­— ğŸ“„</button>
      </div>
      <button class="btn-restart" onclick="restart()">å†è®°å½•ä¸€æ¬¡ ğŸ“–</button>
    </div>
  </div>

  <!-- SCREEN 4: History -->
  <div class="screen" id="screen4">
    <div id="historyContent"></div>
  </div>
</div>

<!-- Floating history button -->
<div class="nav-history" id="navHistory" onclick="goToHistory()">
  ğŸ“š
  <span class="badge" id="historyBadge" style="display:none;">0</span>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Offscreen export card for image generation -->
<div class="export-card-container" id="exportCardContainer"></div>

<!-- Image preview modal -->
<div class="modal-overlay" id="imageModal">
  <div class="modal-content">
    <img id="modalImage" src="" alt="é˜…è¯»è®°å½•">
    <div class="modal-hint">ğŸ“± é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜åˆ°æ‰‹æœºç›¸å†Œ</div>
    <div class="modal-actions">
      <button class="btn-export-outline" onclick="closeModal()">å…³é—­</button>
      <button class="btn-export" onclick="downloadCurrentImage()">ä¸‹è½½å›¾ç‰‡ â¬‡ï¸</button>
    </div>
  </div>
</div>

<script>
// ===== DATA =====
const EMOTIONS = {
  moved: { emoji: 'ğŸ’•', label: 'æ„ŸåŠ¨/å…±é¸£' },
  inspired: { emoji: 'ğŸ’¡', label: 'å¯å‘/é¡¿æ‚Ÿ' },
  healed: { emoji: 'ğŸŒ¿', label: 'æ²»æ„ˆ/å¹³é™' },
  heavy: { emoji: 'ğŸŒŠ', label: 'æ²‰é‡/å‹æŠ‘' },
  curious: { emoji: 'ğŸ”', label: 'å¥½å¥‡/æƒ³æ¢ç´¢' },
  confused: { emoji: 'ğŸŒ€', label: 'å›°æƒ‘/å¤æ‚' }
};

const QUESTION_POOLS = {
  moved: {
    core: [
      { emoji: 'ğŸ«€', text: 'è¿™æ®µå†…å®¹è§¦ç¢°åˆ°äº†ä½ çš„å“ªä¸ªæŸ”è½¯çš„åœ°æ–¹ï¼Ÿ', hint: 'ä¸ç”¨åˆ†æï¼Œå°±è¯´è¯´æ˜¯ä»€ä¹ˆåœ°æ–¹è®©ä½ æœ‰äº†æ„Ÿè§‰', placeholder: 'è¯»åˆ°â€¦â€¦çš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—â€¦â€¦' },
      { emoji: 'ğŸ’§', text: 'å¦‚æœè¦ç”¨ä¸€ä¸ªç”»é¢æ¥å½¢å®¹ä½ åˆšæ‰çš„æ„Ÿå—ï¼Œé‚£ä¼šæ˜¯ä»€ä¹ˆæ ·çš„ç”»é¢ï¼Ÿ', hint: 'å¯ä»¥æ˜¯ä¹¦é‡Œçš„åœºæ™¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ è„‘æµ·ä¸­æµ®ç°çš„ç”»é¢', placeholder: 'æˆ‘è„‘æµ·é‡Œå‡ºç°çš„ç”»é¢æ˜¯â€¦â€¦' },
      { emoji: 'ğŸª', text: 'è¿™æ®µå†…å®¹åƒä¸€é¢é•œå­ï¼Œä½ åœ¨é‡Œé¢çœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿ', hint: 'å¯èƒ½æ˜¯è‡ªå·±çš„æŸæ®µç»å†ï¼Œæˆ–æŸä¸ªäººçš„å½±å­', placeholder: 'æˆ‘å¥½åƒçœ‹åˆ°äº†â€¦â€¦' }
    ],
    expand: [
      { emoji: 'ğŸŒ™', text: 'æœ‰æ²¡æœ‰å“ªå¥è¯æˆ–å“ªä¸ªç»†èŠ‚ï¼Œä½ è§‰å¾—ä»¥åè¿˜ä¼šæƒ³èµ·æ¥ï¼Ÿ', hint: 'ä¸ä¸€å®šæ˜¯æœ€é‡è¦çš„ï¼Œå¯èƒ½å°±æ˜¯è«åå°è±¡æ·±åˆ»çš„', placeholder: 'æˆ‘è§‰å¾—æˆ‘ä¼šè®°ä½â€¦â€¦' },
      { emoji: 'âœ‰ï¸', text: 'å¦‚æœå¯ä»¥å¯¹ä¹¦é‡Œçš„æŸä¸ªè§’è‰²è¯´ä¸€å¥è¯ï¼Œä½ æƒ³è¯´ä»€ä¹ˆï¼Ÿ', hint: 'ä»€ä¹ˆéƒ½å¯ä»¥ï¼Œå®‰æ…°ã€é¼“åŠ±ã€æˆ–è€…åªæ˜¯"æˆ‘æ‡‚ä½ "', placeholder: 'æˆ‘æƒ³å¯¹TAè¯´â€¦â€¦' },
      { emoji: 'ğŸ«§', text: 'è¯»å®Œè¿™ä¸€æ®µï¼Œä½ çš„å¿ƒæƒ…å’Œè¯»ä¹‹å‰æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ', hint: 'å“ªæ€•åªæ˜¯å¾®å¦™çš„å˜åŒ–ä¹Ÿå€¼å¾—è®°å½•', placeholder: 'è¯»ä¹‹å‰æˆ‘â€¦â€¦ï¼Œè¯»å®Œåæˆ‘â€¦â€¦' }
    ]
  },
  inspired: {
    core: [
      { emoji: 'ğŸ’¡', text: 'ä»€ä¹ˆå†…å®¹è®©ä½ çªç„¶æœ‰äº†"åŸæ¥å¦‚æ­¤"çš„æ„Ÿè§‰ï¼Ÿ', hint: 'å¯ä»¥æ˜¯ä¸€ä¸ªè§‚ç‚¹ã€ä¸€ç§æ€è€ƒæ–¹å¼ã€æˆ–ä¸€ä¸ªä½ æ²¡æƒ³åˆ°çš„è§’åº¦', placeholder: 'è®©æˆ‘æœ‰å¯å‘çš„æ˜¯â€¦â€¦' },
      { emoji: 'ğŸ”‘', text: 'å¦‚æœè¦æŠŠä»Šå¤©è¯»åˆ°çš„ç²¾åæµ“ç¼©æˆä¸€å¥è¯ç»™æœ‹å‹ï¼Œä½ ä¼šæ€ä¹ˆè¯´ï¼Ÿ', hint: 'ç”¨ä½ è‡ªå·±çš„è¯æ¥è¯´', placeholder: 'æˆ‘ä¼šè¯´â€¦â€¦' },
      { emoji: 'ğŸ§©', text: 'è¿™æ®µå†…å®¹å’Œä½ ä¹‹å‰çŸ¥é“çš„ä¸œè¥¿äº§ç”Ÿäº†ä»€ä¹ˆæ–°çš„è¿æ¥ï¼Ÿ', hint: 'å¯èƒ½æ¥ä¸Šäº†æŸä¸ªä½ ä¸€ç›´åœ¨æƒ³çš„é—®é¢˜', placeholder: 'æˆ‘å‘ç°å®ƒå’Œâ€¦â€¦æœ‰å…³è”' }
    ],
    expand: [
      { emoji: 'ğŸŒ±', text: 'è¿™ä¸ªå¯å‘ä¼šè®©ä½ æƒ³è¦åšä»€ä¹ˆæ”¹å˜å—ï¼Ÿå“ªæ€•å¾ˆå°çš„ä¹Ÿç®—', hint: 'ä¸ç”¨æƒ³å¤ªå¤§ï¼Œä¸€ä¸ªå°å°çš„è¡ŒåŠ¨æƒ³æ³•å°±å¾ˆå¥½', placeholder: 'æˆ‘æƒ³è¯•è¯•â€¦â€¦' },
      { emoji: 'â“', text: 'è¯»å®Œè¿™æ®µï¼Œä½ å†’å‡ºäº†ä»€ä¹ˆæ–°çš„é—®é¢˜æˆ–å¥½å¥‡ï¼Ÿ', hint: 'æœ‰æ—¶å€™å¥½çš„é˜…è¯»ä¸æ˜¯ç»™ç­”æ¡ˆï¼Œè€Œæ˜¯æ‰“å¼€æ–°çš„é—®é¢˜', placeholder: 'æˆ‘ç°åœ¨å¾ˆå¥½å¥‡â€¦â€¦' }
    ]
  },
  healed: {
    core: [
      { emoji: 'ğŸŒ¿', text: 'è¿™æ®µå†…å®¹ç»™äº†ä½ æ€æ ·çš„å®‰æ…°æˆ–å®é™æ„Ÿï¼Ÿ', hint: 'ä¸ç”¨è§£é‡Šä¸ºä»€ä¹ˆï¼Œæè¿°é‚£ä¸ªæ„Ÿè§‰å°±å¥½', placeholder: 'è¯»çš„æ—¶å€™æˆ‘æ„Ÿè§‰â€¦â€¦' },
      { emoji: 'â˜ï¸', text: 'å¦‚æœè¿™æ®µé˜…è¯»æ˜¯ä¸€ç§å¤©æ°”ï¼Œå®ƒæ˜¯ä»€ä¹ˆæ ·çš„å¤©æ°”ï¼Ÿ', hint: 'æ™´å¤©ã€å°é›¨ã€å¾®é£ã€é›ªååˆæ™´â€¦â€¦æ„Ÿè§‰æ˜¯ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆ', placeholder: 'åƒæ˜¯â€¦â€¦' },
      { emoji: 'ğŸ«¶', text: 'è¿™æ®µæ–‡å­—é‡Œæœ‰æ²¡æœ‰å“ªå¥è®©ä½ æƒ³æ·±å‘¼å¸ä¸€ä¸‹çš„ï¼Ÿ', hint: 'é‚£ç§è¯»åˆ°ä¼š"å—¯â€¦"çš„æ„Ÿè§‰', placeholder: 'è®©æˆ‘å¿ƒé™ä¸‹æ¥çš„æ˜¯â€¦â€¦' }
    ],
    expand: [
      { emoji: 'ğŸ•Šï¸', text: 'ä½ è§‰å¾—ä¹¦é‡Œçš„ä»€ä¹ˆè®©ä½ æ„Ÿåˆ°è¢«æ¸©æŸ”å¯¹å¾…äº†ï¼Ÿ', hint: 'å¯èƒ½æ˜¯ä¸€ä¸ªè§’è‰²çš„è¡Œä¸ºï¼Œä¹Ÿå¯èƒ½æ˜¯ä½œè€…çš„å†™æ³•', placeholder: 'æˆ‘è§‰å¾—æ¸©æŸ”çš„åœ°æ–¹æ˜¯â€¦â€¦' },
      { emoji: 'ğŸ›‹ï¸', text: 'è¯»å®Œåä½ æƒ³åšä»€ä¹ˆï¼Ÿå‘å‘†ã€å–æ¯èŒ¶ã€è¿˜æ˜¯ç»§ç»­å¾…åœ¨è¿™ä¸ªæ•…äº‹é‡Œï¼Ÿ', hint: 'é˜…è¯»åçš„ä½™éŸµä¹Ÿå¾ˆå€¼å¾—è®°ä½', placeholder: 'è¯»å®Œåæˆ‘æƒ³â€¦â€¦' }
    ]
  },
  heavy: {
    core: [
      { emoji: 'ğŸŒŠ', text: 'æ˜¯ä»€ä¹ˆè®©ä½ è§‰å¾—æ²‰é‡ï¼Ÿ', hint: 'å¯ä»¥åªæ˜¯æè¿°é‚£ä¸ªæ„Ÿè§‰ï¼Œä¸ç”¨åˆ†æåŸå› ', placeholder: 'è®©æˆ‘è§‰å¾—æ²‰é‡çš„æ˜¯â€¦â€¦' },
      { emoji: 'ğŸª¨', text: 'è¿™ç§æ²‰é‡æ„Ÿï¼Œåƒæ˜¯å‹åœ¨ä½ èº«ä½“çš„å“ªä¸ªéƒ¨ä½ï¼Ÿ', hint: 'æœ‰æ—¶å€™æƒ…ç»ªæ˜¯æœ‰èº«ä½“æ„Ÿè§‰çš„ï¼Œæ¯”å¦‚èƒ¸å£ã€è‚©è†€ã€çœ¼çœ¶', placeholder: 'æ„Ÿè§‰åƒæ˜¯â€¦â€¦' },
      { emoji: 'ğŸŒ‘', text: 'å¦‚æœè¦ç»™è¿™æ®µé˜…è¯»é€‰ä¸€ä¸ªé¢œè‰²ï¼Œä½ ä¼šé€‰ä»€ä¹ˆè‰²ï¼Ÿ', hint: 'ç›´è§‰é€‰å°±å¥½', placeholder: 'æˆ‘è§‰å¾—æ˜¯â€¦â€¦è‰²' }
    ],
    expand: [
      { emoji: 'ğŸ•¯ï¸', text: 'åœ¨è¿™ä»½æ²‰é‡é‡Œï¼Œæœ‰æ²¡æœ‰ä¸€ç‚¹ç‚¹å¾®å…‰è®©ä½ è§‰å¾—è¿˜å¥½ï¼Ÿ', hint: 'ä¹Ÿè®¸æœ‰ï¼Œä¹Ÿè®¸æ²¡æœ‰ï¼Œéƒ½å¯ä»¥', placeholder: 'å¦‚æœæœ‰çš„è¯ï¼Œé‚£æ˜¯â€¦â€¦' },
      { emoji: 'ğŸ’¬', text: 'ä½ æƒ³è·Ÿè°èŠèŠä½ åˆšæ‰è¯»åˆ°çš„ä¸œè¥¿ï¼Ÿ', hint: 'æœ‰æ—¶å€™æ²‰é‡éœ€è¦åˆ†äº«å‡ºå»æ‰ä¼šè½»ä¸€ç‚¹', placeholder: 'æˆ‘æƒ³è·Ÿâ€¦â€¦èŠèŠ' }
    ]
  },
  curious: {
    core: [
      { emoji: 'ğŸ”', text: 'ä½ æœ€å¥½å¥‡æˆ–æœ€æƒ³çŸ¥é“åé¢ä¼šå‘ç”Ÿä»€ä¹ˆçš„æ˜¯å“ªä¸ªéƒ¨åˆ†ï¼Ÿ', hint: 'å¯èƒ½æ˜¯ä¸€ä¸ªæ‚¬å¿µã€ä¸€ä¸ªè§’è‰²çš„èµ°å‘ã€æˆ–ä¸€ä¸ªè¿˜æ²¡æ­å¼€çš„è°œ', placeholder: 'æˆ‘æœ€å¥½å¥‡çš„æ˜¯â€¦â€¦' },
      { emoji: 'ğŸ—ºï¸', text: 'è¯»åˆ°ç°åœ¨ï¼Œä½ å¯¹è¿™ä¸ªæ•…äº‹/è¿™æœ¬ä¹¦æœ€å¤§çš„æœŸå¾…æ˜¯ä»€ä¹ˆï¼Ÿ', hint: 'ä½ å¸Œæœ›æ¥ä¸‹æ¥çœ‹åˆ°ä»€ä¹ˆ', placeholder: 'æˆ‘æœŸå¾…â€¦â€¦' },
      { emoji: 'ğŸ§²', text: 'æ˜¯ä»€ä¹ˆåœ¨å¸å¼•ä½ ç»§ç»­è¯»ä¸‹å»ï¼Ÿ', hint: 'æ•…äº‹ï¼Ÿäººç‰©ï¼Ÿå†™æ³•ï¼Ÿè¿˜æ˜¯æŸç§è¯´ä¸æ¸…çš„æ„Ÿè§‰ï¼Ÿ', placeholder: 'å¸å¼•æˆ‘çš„æ˜¯â€¦â€¦' }
    ],
    expand: [
      { emoji: 'ğŸ“Œ', text: 'ä½ æœ‰æ²¡æœ‰åœ¨çœ‹çš„æ—¶å€™äº§ç”Ÿè¿‡ä»€ä¹ˆè‡ªå·±çš„çŒœæµ‹ï¼Ÿ', hint: 'çŒœæµ‹åé¢ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œæˆ–è€…æŸä¸ªä¼ç¬”æ˜¯ä»€ä¹ˆæ„æ€', placeholder: 'æˆ‘çŒœâ€¦â€¦' },
      { emoji: 'ğŸŒ', text: 'è¿™æœ¬ä¹¦è®©ä½ å¯¹ç°å®ä¸­çš„ä»€ä¹ˆäº‹æƒ…äº§ç”Ÿäº†æ–°çš„å¥½å¥‡ï¼Ÿ', hint: 'ä¹Ÿè®¸çœ‹å®Œä¹‹åä½ æƒ³å»äº†è§£æŸä¸ªè¯é¢˜', placeholder: 'æˆ‘æƒ³å»äº†è§£â€¦â€¦' }
    ]
  },
  confused: {
    core: [
      { emoji: 'ğŸŒ€', text: 'ä½ è§‰å¾—å¤æ‚æˆ–å›°æƒ‘çš„ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ', hint: 'çœ‹ä¸æ‡‚ã€çŸ›ç›¾çš„æ„Ÿè§‰ã€æˆ–è€…è¯´ä¸æ¸…ä¸ºä»€ä¹ˆï¼Œéƒ½ç®—', placeholder: 'è®©æˆ‘å›°æƒ‘çš„æ˜¯â€¦â€¦' },
      { emoji: 'ğŸ­', text: 'ä½ å¯¹ä¹¦ä¸­çš„æŸä¸ªè§’è‰²æˆ–æƒ…èŠ‚æœ‰æ²¡æœ‰"åˆç†è§£åˆä¸ç†è§£"çš„æ„Ÿè§‰ï¼Ÿ', hint: 'é‚£ç§çº ç»“çš„ã€çŸ›ç›¾çš„æ„Ÿå—åè€Œè¯´æ˜ä½ åœ¨æ·±å…¥æ€è€ƒ', placeholder: 'æˆ‘å¯¹â€¦â€¦çš„æ„Ÿè§‰å¾ˆçŸ›ç›¾ï¼Œå› ä¸ºâ€¦â€¦' },
      { emoji: 'ğŸ”®', text: 'ä½ è§‰å¾—ä½œè€…æƒ³è¡¨è¾¾ä»€ä¹ˆï¼Ÿä½ è‡ªå·±çš„ç†è§£æ˜¯ä»€ä¹ˆï¼Ÿ', hint: 'æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆï¼Œä½ çš„ç†è§£å°±æ˜¯æœ€å¥½çš„ç†è§£', placeholder: 'æˆ‘è§‰å¾—ä½œè€…å¯èƒ½æƒ³è¯´â€¦â€¦' }
    ],
    expand: [
      { emoji: 'ğŸ§¶', text: 'è™½ç„¶ç°åœ¨çœ‹ä¸å¤ªæ˜ç™½ï¼Œä½†ä½ è§‰å¾—ç»§ç»­çœ‹ä¸‹å»ä¼šæ‡‚å—ï¼Ÿ', hint: 'æœ‰æ—¶å€™å›°æƒ‘æ˜¯ä¸€ç§é‚€è¯·ï¼Œé‚€è¯·ä½ ç»§ç»­å¾€ä¸‹çœ‹', placeholder: 'æˆ‘è§‰å¾—â€¦â€¦' },
      { emoji: 'ğŸ’­', text: 'è¿™ä¸ªå›°æƒ‘è®©ä½ æƒ³åˆ°äº†ç”Ÿæ´»ä¸­çš„ä»€ä¹ˆå—ï¼Ÿ', hint: 'æœ‰æ—¶å€™æˆ‘ä»¬è¢«ä¹¦å›°æƒ‘ï¼Œæ˜¯å› ä¸ºå®ƒæ’ä¸Šäº†æˆ‘ä»¬è‡ªå·±çš„å›°æƒ‘', placeholder: 'å®ƒè®©æˆ‘æƒ³åˆ°â€¦â€¦' }
    ]
  }
};

// ===== STATE =====
let selectedEmotions = [];
let currentQuestions = [];
let currentQuestionIndex = 0;
let answers = {};
let isExpanded = false;
let allRecords = JSON.parse(localStorage.getItem('readingJournal') || '[]');
let currentExportImageUrl = null;

updateHistoryBadge();

// ===== DATE =====
function showDate() {
  const now = new Date();
  const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
  document.getElementById('dateDisplay').textContent = now.toLocaleDateString('zh-CN', options);
}
showDate();

// ===== EMOTION SELECTION =====
function toggleEmotion(btn) {
  const emotion = btn.dataset.emotion;
  if (btn.classList.contains('selected')) {
    btn.classList.remove('selected');
    selectedEmotions = selectedEmotions.filter(e => e !== emotion);
  } else {
    if (selectedEmotions.length >= 2) {
      const firstSelected = document.querySelector(`.emotion-btn[data-emotion="${selectedEmotions[0]}"]`);
      firstSelected.classList.remove('selected');
      selectedEmotions.shift();
    }
    btn.classList.add('selected');
    selectedEmotions.push(emotion);
  }
  const hint = document.getElementById('multiHint');
  document.getElementById('selectedCount').textContent = selectedEmotions.length;
  hint.classList.toggle('visible', selectedEmotions.length > 0);
  updateStartBtn();
}

function updateStartBtn() {
  const title = document.getElementById('bookTitle').value.trim();
  document.getElementById('startBtn').disabled = !(title && selectedEmotions.length > 0);
}
document.getElementById('bookTitle').addEventListener('input', updateStartBtn);

// ===== GENERATE QUESTIONS =====
function generateQuestions() {
  const questions = [];
  selectedEmotions.forEach(emotion => {
    const pool = QUESTION_POOLS[emotion];
    const coreIdx = Math.floor(Math.random() * pool.core.length);
    questions.push({ ...pool.core[coreIdx], type: 'core', emotion });
  });
  const expandPool = [];
  selectedEmotions.forEach(emotion => {
    QUESTION_POOLS[emotion].expand.forEach(q => expandPool.push({ ...q, type: 'expand', emotion }));
  });
  const expandQuestions = expandPool.sort(() => Math.random() - 0.5).slice(0, Math.min(3, expandPool.length));
  return { core: questions, expand: expandQuestions };
}

// ===== QUESTION FLOW =====
function goToQuestions() {
  const generated = generateQuestions();
  currentQuestions = generated.core;
  window._expandQuestions = generated.expand;
  currentQuestionIndex = 0;
  answers = {};
  isExpanded = false;
  switchScreen('screen2');
  renderQuestion();
}

function renderQuestion() {
  const flow = document.getElementById('questionFlow');
  const q = currentQuestions[currentQuestionIndex];
  const isLast = currentQuestionIndex === currentQuestions.length - 1;
  const savedAnswer = answers[currentQuestionIndex] || '';

  let dotsHtml = '';
  for (let i = 0; i < currentQuestions.length; i++) {
    const cls = i < currentQuestionIndex ? 'done' : (i === currentQuestionIndex ? 'current' : '');
    dotsHtml += `<div class="progress-dot ${cls}"></div>`;
  }

  flow.innerHTML = `
    <div class="question-progress fade-enter">
      <div class="progress-dots">${dotsHtml}</div>
      <div class="progress-text">${currentQuestionIndex + 1} / ${currentQuestions.length}</div>
    </div>
    <div class="question-card">
      <div class="question-emoji">${q.emoji}</div>
      <div class="question-text">${q.text}</div>
      <div class="question-hint">${q.hint}</div>
      <textarea class="answer-textarea" id="answerInput" placeholder="${q.placeholder || 'å†™ä¸‹ä½ çš„æƒ³æ³•â€¦â€¦'}" oninput="autoGrow(this)">${savedAnswer}</textarea>
      <div class="question-actions">
        ${currentQuestionIndex > 0 ? '<button class="btn-secondary" onclick="prevQuestion()">ä¸Šä¸€ä¸ª</button>' : '<button class="btn-secondary" onclick="skipQuestion()">è·³è¿‡</button>'}
        <button class="btn-next" onclick="${isLast ? (isExpanded ? 'finish()' : 'showExpandOption()') : 'nextQuestion()'}">
          ${isLast ? (isExpanded ? 'å®Œæˆè®°å½• âœ¨' : 'ä¸‹ä¸€æ­¥') : 'ä¸‹ä¸€ä¸ª â†’'}
        </button>
      </div>
    </div>
    ${isLast && !isExpanded ? `<div class="expand-section"><button class="expand-btn" onclick="showExpandOption()">è¿˜æƒ³å¤šå†™å‡ ä¸ªï¼Ÿ â†“</button></div>` : ''}
    ${isLast ? `<div style="text-align:center;margin-top:4px;opacity:0;animation:fadeUp 0.5s ease 0.3s forwards;"><button class="btn-secondary" style="display:inline-block;width:auto;padding:10px 24px;font-size:13px;" onclick="finish()">å°±å†™åˆ°è¿™é‡Œ âœ“</button></div>` : ''}
  `;
  setTimeout(() => {
    const textarea = document.getElementById('answerInput');
    if (textarea) { textarea.focus(); autoGrow(textarea); }
  }, 100);
}

function autoGrow(el) { el.style.height = 'auto'; el.style.height = Math.max(120, el.scrollHeight) + 'px'; }
function saveCurrentAnswer() { const t = document.getElementById('answerInput'); if (t) answers[currentQuestionIndex] = t.value; }
function nextQuestion() { saveCurrentAnswer(); if (currentQuestionIndex < currentQuestions.length - 1) { currentQuestionIndex++; renderQuestion(); } }
function prevQuestion() { saveCurrentAnswer(); if (currentQuestionIndex > 0) { currentQuestionIndex--; renderQuestion(); } }
function skipQuestion() { answers[currentQuestionIndex] = ''; if (currentQuestionIndex < currentQuestions.length - 1) { currentQuestionIndex++; renderQuestion(); } }

function showExpandOption() {
  saveCurrentAnswer();
  if (window._expandQuestions && window._expandQuestions.length > 0) {
    currentQuestions = [...currentQuestions, ...window._expandQuestions];
    window._expandQuestions = [];
    isExpanded = true;
    currentQuestionIndex++;
    renderQuestion();
  } else {
    finish();
  }
}

// ===== FINISH & SAVE =====
function finish() {
  saveCurrentAnswer();
  const record = buildRecord();
  allRecords.unshift(record);
  saveRecords();
  updateHistoryBadge();
  switchScreen('screen3');
  renderSummary();
}

function buildRecord() {
  const now = new Date();
  const qa = [];
  currentQuestions.forEach((q, i) => {
    const answer = answers[i];
    if (answer && answer.trim()) qa.push({ emoji: q.emoji, question: q.text, answer: answer.trim() });
  });
  return {
    id: Date.now().toString(),
    date: now.toISOString(),
    bookTitle: document.getElementById('bookTitle').value,
    progress: document.getElementById('readingProgress').value,
    readingTime: document.getElementById('readingTime').value,
    emotions: selectedEmotions.map(e => ({ key: e, ...EMOTIONS[e] })),
    qa
  };
}

function saveRecords() { localStorage.setItem('readingJournal', JSON.stringify(allRecords)); }

function updateHistoryBadge() {
  const badge = document.getElementById('historyBadge');
  if (allRecords.length > 0) { badge.style.display = 'flex'; badge.textContent = allRecords.length > 99 ? '99+' : allRecords.length; }
  else { badge.style.display = 'none'; }
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ===== RENDER SUMMARY =====
function renderSummary() {
  const card = document.getElementById('summaryCard');
  const r = allRecords[0];
  card.innerHTML = buildSummaryHtml(r);
}

function buildSummaryHtml(r) {
  const d = new Date(r.date);
  const dateStr = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
  const emotionTags = r.emotions.map(e => `<span class="summary-emotion-tag">${e.emoji} ${e.label}</span>`).join('');
  let qaHtml = '';
  r.qa.forEach(item => {
    qaHtml += `<div class="summary-qa"><div class="summary-q">${item.emoji} ${item.question}</div><div class="summary-a">${item.answer}</div></div>`;
  });
  const metaParts = [];
  if (r.progress) metaParts.push(r.progress);
  if (r.readingTime) metaParts.push('é˜…è¯» ' + r.readingTime);
  metaParts.push(dateStr);
  return `
    <div class="summary-header"><div><div class="summary-book-title">ğŸ“š ${r.bookTitle}</div><div class="summary-meta">${metaParts.join(' Â· ')}</div></div></div>
    <div class="summary-emotion-tags">${emotionTags}</div>
    ${qaHtml || '<div class="summary-a" style="color:var(--text-light);">è¿™æ¬¡æ²¡æœ‰å†™æ„Ÿå—ï¼Œä½†ç¿»å¼€ä¹¦æœ¬èº«å°±å¾ˆæ£’ âœ¨</div>'}
  `;
}

// ===== NAVIGATION =====
function switchScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
  document.getElementById('navHistory').style.display = screenId === 'screen4' ? 'none' : 'flex';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function restart() {
  selectedEmotions = [];
  currentQuestions = [];
  currentQuestionIndex = 0;
  answers = {};
  isExpanded = false;
  document.getElementById('bookTitle').value = '';
  document.getElementById('readingProgress').value = '';
  document.getElementById('readingTime').value = '';
  document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('selected'));
  document.getElementById('multiHint').classList.remove('visible');
  document.getElementById('startBtn').disabled = true;
  switchScreen('screen1');
}

// ===== IMAGE EXPORT =====
function buildExportCard(r) {
  const d = new Date(r.date);
  const dateStr = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
  const emotionTags = r.emotions.map(e => `<span class="ec-emotion-tag">${e.emoji} ${e.label}</span>`).join('');
  const metaParts = [];
  if (r.progress) metaParts.push(r.progress);
  if (r.readingTime) metaParts.push('é˜…è¯» ' + r.readingTime);
  metaParts.push(dateStr);

  let qaHtml = '';
  r.qa.forEach(item => {
    qaHtml += `<div class="ec-qa"><div class="ec-question">${item.emoji} ${item.question}</div><div class="ec-answer">${item.answer}</div></div>`;
  });

  return `
    <div class="export-card" id="exportCard">
      <div class="ec-header">
        <div class="ec-logo">ğŸ“–</div>
        <div class="ec-app-name">è¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹</div>
      </div>
      <div class="ec-book-title">ğŸ“š ${r.bookTitle}</div>
      <div class="ec-meta">${metaParts.join(' Â· ')}</div>
      <div class="ec-emotions">${emotionTags}</div>
      <div class="ec-divider"></div>
      ${qaHtml || '<div class="ec-answer" style="text-align:center;color:#A89E8E;">ç¿»å¼€ä¹¦æœ¬èº«å°±å¾ˆæ£’ âœ¨</div>'}
      <div class="ec-footer">â€” è®°å½•äºã€Œè¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹ã€â€”</div>
    </div>
  `;
}

async function generateImage(r) {
  const container = document.getElementById('exportCardContainer');
  container.innerHTML = buildExportCard(r);
  
  // Wait for fonts to render
  await new Promise(resolve => setTimeout(resolve, 300));
  
  const card = document.getElementById('exportCard');
  const canvas = await html2canvas(card, {
    scale: 2,
    backgroundColor: null,
    useCORS: true,
    logging: false,
    width: 420,
    windowWidth: 420
  });

  container.innerHTML = '';
  return canvas.toDataURL('image/png');
}

async function exportCurrentAsImage() {
  if (allRecords.length === 0) return;
  const btn = document.getElementById('btnExportImg');
  btn.classList.add('btn-loading');
  btn.textContent = 'ç”Ÿæˆä¸­â€¦';
  
  try {
    const url = await generateImage(allRecords[0]);
    currentExportImageUrl = url;
    showImageModal(url);
  } catch (e) {
    showToast('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    console.error(e);
  }
  
  btn.classList.remove('btn-loading');
  btn.textContent = 'ä¿å­˜ä¸ºå›¾ç‰‡ ğŸ–¼ï¸';
}

async function exportSingleAsImage(id) {
  const r = allRecords.find(rec => rec.id === id);
  if (!r) return;
  showToast('ç”Ÿæˆå›¾ç‰‡ä¸­â€¦');
  
  try {
    const url = await generateImage(r);
    currentExportImageUrl = url;
    showImageModal(url);
  } catch (e) {
    showToast('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    console.error(e);
  }
}

function showImageModal(url) {
  document.getElementById('modalImage').src = url;
  document.getElementById('imageModal').classList.add('show');
}

function closeModal() {
  document.getElementById('imageModal').classList.remove('show');
}

function downloadCurrentImage() {
  if (!currentExportImageUrl) return;
  const a = document.createElement('a');
  a.href = currentExportImageUrl;
  a.download = 'é˜…è¯»è®°å½•_' + new Date().getTime() + '.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast('å›¾ç‰‡å·²ä¸‹è½½ âœ“');
}

// Close modal on overlay click
document.getElementById('imageModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ===== MARKDOWN EXPORT =====
function recordToMarkdown(r) {
  const d = new Date(r.date);
  const dateStr = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
  const emotions = r.emotions.map(e => `${e.emoji} ${e.label}`).join('ã€');
  let md = `## ğŸ“š ${r.bookTitle}\n\n`;
  md += `**æ—¥æœŸ**ï¼š${dateStr}\n`;
  if (r.progress) md += `**è¿›åº¦**ï¼š${r.progress}\n`;
  if (r.readingTime) md += `**é˜…è¯»æ—¶é•¿**ï¼š${r.readingTime}\n`;
  md += `**æ„Ÿå—**ï¼š${emotions}\n\n`;
  r.qa.forEach(item => { md += `### ${item.emoji} ${item.question}\n\n${item.answer}\n\n`; });
  md += `---\n\n`;
  return md;
}

function downloadMarkdown(filename, content) {
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('å·²å¯¼å‡º âœ“');
}

function exportCurrentAsMd() {
  if (allRecords.length === 0) return;
  const r = allRecords[0];
  const content = `# è¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹ - é˜…è¯»æ„Ÿå—è®°å½•\n\n` + recordToMarkdown(r);
  const safeTitle = r.bookTitle.replace(/[^\w\u4e00-\u9fff]/g, '_').substring(0, 20);
  downloadMarkdown(`é˜…è¯»è®°å½•_${safeTitle}.md`, content);
}

function exportSingleAsMd(id) {
  const r = allRecords.find(rec => rec.id === id);
  if (!r) return;
  const content = `# è¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹ - é˜…è¯»æ„Ÿå—è®°å½•\n\n` + recordToMarkdown(r);
  const safeTitle = r.bookTitle.replace(/[^\w\u4e00-\u9fff]/g, '_').substring(0, 20);
  downloadMarkdown(`é˜…è¯»è®°å½•_${safeTitle}.md`, content);
}

function exportAllAsMd() {
  if (allRecords.length === 0) return;
  let content = `# è¯»ä¸€ç‚¹ï¼Œå†™ä¸€ç‚¹ - å…¨éƒ¨é˜…è¯»è®°å½•\n\nå…± ${allRecords.length} æ¡è®°å½•\n\n---\n\n`;
  allRecords.forEach(r => { content += recordToMarkdown(r); });
  const d = new Date();
  downloadMarkdown(`å…¨éƒ¨é˜…è¯»è®°å½•_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.md`, content);
}

// ===== HISTORY =====
function goToHistory() {
  switchScreen('screen4');
  renderHistoryList();
}

function renderHistoryList() {
  const content = document.getElementById('historyContent');
  if (allRecords.length === 0) {
    content.innerHTML = `
      <div class="history-header"><h2>ğŸ“š é˜…è¯»è®°å½•</h2><button class="history-back" onclick="backFromHistory()">è¿”å›</button></div>
      <div class="history-empty"><div class="history-empty-icon">ğŸ“</div>è¿˜æ²¡æœ‰ä»»ä½•è®°å½•<br>å»è¯»ä¸€ç‚¹ã€å†™ä¸€ç‚¹å§</div>
    `;
    return;
  }

  const books = {};
  allRecords.forEach(r => { if (!books[r.bookTitle]) books[r.bookTitle] = []; books[r.bookTitle].push(r); });

  let listHtml = '';
  allRecords.forEach((r, idx) => {
    const d = new Date(r.date);
    const dateStr = `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
    const emotionStr = r.emotions.map(e => `<span class="history-entry-emotion">${e.emoji} ${e.label}</span>`).join('');
    const preview = r.qa.length > 0 ? r.qa[0].answer : 'æ²¡æœ‰å†™æ„Ÿå—';
    listHtml += `
      <div class="history-entry" style="animation-delay:${idx * 0.05}s" onclick="viewRecord('${r.id}')">
        <div class="history-entry-header"><div class="history-entry-title">${r.bookTitle}</div><div class="history-entry-date">${dateStr}</div></div>
        <div class="history-entry-emotions">${emotionStr}</div>
        <div class="history-entry-preview">${preview}</div>
      </div>
    `;
  });

  content.innerHTML = `
    <div class="history-header"><h2>ğŸ“š é˜…è¯»è®°å½•</h2><button class="history-back" onclick="backFromHistory()">è¿”å›</button></div>
    <div class="history-stats">
      <div class="stat-card"><div class="stat-number">${allRecords.length}</div><div class="stat-label">æ¬¡è®°å½•</div></div>
      <div class="stat-card"><div class="stat-number">${Object.keys(books).length}</div><div class="stat-label">æœ¬ä¹¦</div></div>
    </div>
    <div class="history-list">${listHtml}</div>
    <div class="history-export-all">
      <button class="btn-export" style="width:100%;opacity:1;animation:none;" onclick="exportAllAsMd()">å¯¼å‡ºå…¨éƒ¨è®°å½• ğŸ“„</button>
    </div>
  `;
}

function viewRecord(id) {
  const r = allRecords.find(rec => rec.id === id);
  if (!r) return;
  const content = document.getElementById('historyContent');
  content.innerHTML = `
    <button class="detail-back" onclick="renderHistoryList()">â† è¿”å›åˆ—è¡¨</button>
    <div class="summary-card fade-enter" style="opacity:1;">${buildSummaryHtml(r)}</div>
    <div style="display:flex;gap:10px;margin-top:12px;">
      <button class="btn-export" style="flex:1;opacity:1;animation:none;" onclick="exportSingleAsImage('${r.id}')">ä¿å­˜å›¾ç‰‡ ğŸ–¼ï¸</button>
      <button class="btn-export-outline" style="flex:1;" onclick="exportSingleAsMd('${r.id}')">å¯¼å‡ºæ–‡å­— ğŸ“„</button>
    </div>
    <div style="text-align:center;margin-top:12px;">
      <button class="detail-delete" onclick="deleteRecord('${r.id}')">åˆ é™¤æ­¤è®°å½•</button>
    </div>
  `;
}

function deleteRecord(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
  allRecords = allRecords.filter(r => r.id !== id);
  saveRecords();
  updateHistoryBadge();
  showToast('å·²åˆ é™¤');
  renderHistoryList();
}

function backFromHistory() { switchScreen('screen1'); }
</script>

</body>
</html>
